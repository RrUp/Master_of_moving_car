{"version":3,"sources":["LoadingSceneJS.js"],"names":["GameDataManager","require","define","point","isLoading","isAuthorization","cc","Class","extends","Component","properties","wxlog_btn","Node","loadingBar","type","ProgressBar","default","loadinglab","Sprite","loadingpercent","Label","titlebg","audioControl","onLoad","CC_WECHATGAME","game","on","sure","console","log","active","node","getInstance","preLoadingdata","getgold","savegold","money","getInfo","progress","sys","localStorage","clear","Promise","resolve","reject","wx","getSetting","success","res","authSetting","createUserInfoButton","button","text","style","left","top","width","height","lineHeight","backgroundColor","color","textAlign","fontSize","borderRadius","onTap","getUserInfo","hide","nickName","userInfo","avatarUrl","emit","fail","authorize","scope","start","director","preloadScene","update","dt","updateload","onLoadComplete","string","Math","floor","loadScene"],"mappings":";;;;;;AAAA,IAAIA,kBAAkBC,QAAQ,mBAAR,CAAtB;AACA,IAAIC,SAASD,QAAQ,QAAR,CAAb;AACA,IAAIE,QAAQ,CAAZ;AACA,IAAIC,YAAY,KAAhB;AACA,IAAIC,kBAAkB,KAAtB;AACAC,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,mBAAWL,GAAGM,IADN;AAERC,oBAAY;AACRC,kBAAMR,GAAGS,WADD;AAERC,qBAAS;AAFD,SAFJ;AAMRC,oBAAYX,GAAGY,MANP;AAORC,wBAAgBb,GAAGc,KAPX;AAQRC,iBAASf,GAAGY,MARJ;AASRI,sBACA;AACIN,qBAAS;AADb;AAVQ,KAHP;AAiBLO,UAjBK,oBAiBI;AAAA;;AAEL,YAAIC,aAAJ,EAAmB;AACflB,eAAGmB,IAAH,CAAQC,EAAR,CAAW,SAAX,EAAsB,UAACC,IAAD,EAAU;AAC5B,oBAAIA,IAAJ,EAAU;AACNC,4BAAQC,GAAR,CAAY,OAAZ;AACAxB,sCAAkB,IAAlB;AACA,0BAAKM,SAAL,CAAemB,MAAf,GAAwB,KAAxB;AACA,0BAAKjB,UAAL,CAAgBkB,IAAhB,CAAqBD,MAArB,GAA8B,IAA9B;AACA,0BAAKb,UAAL,CAAgBc,IAAhB,CAAqBD,MAArB,GAA8B,IAA9B;AACA,0BAAKX,cAAL,CAAoBY,IAApB,CAAyBD,MAAzB,GAAkC,IAAlC;;AAEA9B,oCAAgBgC,WAAhB,GAA8BC,cAA9B;AACA,wBAAI,CAAC/B,OAAOgC,OAAP,EAAL,EAAuB;AACnBlC,wCAAgBgC,WAAhB,GAA8BG,QAA9B,CAAuCjC,OAAOkC,KAA9C;AACA9B,2BAAGuB,GAAH,CAAO,sBAAP,EAA+B7B,gBAAgBgC,WAAhB,GAA8BE,OAA9B,EAA/B;AACH;AACJ,iBAbD,MAcK,CAAG;AACX,aAhBD;AAiBA,iBAAKG,OAAL;AACA,iBAAKxB,UAAL,CAAgByB,QAAhB,GAA2B,CAA3B;AACA,iBAAKzB,UAAL,CAAgBkB,IAAhB,CAAqBD,MAArB,GAA8B,KAA9B;AACA,iBAAKb,UAAL,CAAgBc,IAAhB,CAAqBD,MAArB,GAA8B,KAA9B;AACA,iBAAKX,cAAL,CAAoBY,IAApB,CAAyBD,MAAzB,GAAkC,KAAlC;AACH,SAvBD,MAwBK;AACDF,oBAAQC,GAAR,CAAY,OAAZ;AACAvB,eAAGiC,GAAH,CAAOC,YAAP,CAAoBC,KAApB;AACApC,8BAAkB,IAAlB;AACA,iBAAKM,SAAL,CAAemB,MAAf,GAAwB,KAAxB;AACA,iBAAKjB,UAAL,CAAgBkB,IAAhB,CAAqBD,MAArB,GAA8B,IAA9B;AACA,iBAAKb,UAAL,CAAgBc,IAAhB,CAAqBD,MAArB,GAA8B,IAA9B;AACA,iBAAKX,cAAL,CAAoBY,IAApB,CAAyBD,MAAzB,GAAkC,IAAlC;;AAEA9B,4BAAgBgC,WAAhB,GAA8BC,cAA9B;AACA,gBAAI,CAAC/B,OAAOgC,OAAP,EAAL,EAAuB;AACnBlC,gCAAgBgC,WAAhB,GAA8BG,QAA9B,CAAuCjC,OAAOkC,KAA9C;AACA9B,mBAAGuB,GAAH,CAAO,sBAAP,EAA+B7B,gBAAgBgC,WAAhB,GAA8BE,OAA9B,EAA/B;AACH;AACJ;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KArEI;AAsELG,WAtEK,qBAsEK;AACN,eAAO,IAAIK,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC1C,gBAAIpB,aAAJ,EAAmB;AACfqB,mBAAGC,UAAH,CAAc;AACVC,2BADU,mBACFC,GADE,EACG;AACT,4BAAI,CAACA,IAAIC,WAAJ,CAAgB,gBAAhB,CAAL,EAAwC;AACpC,gCAAIJ,GAAGK,oBAAP,EAA6B;AACzB,oCAAIC,SAASN,GAAGK,oBAAH,CAAwB;AACjCpC,0CAAM,MAD2B;AAEjCsC,0CAAM,EAF2B;AAGjCC,2CAAO;AACHC,8CAAM,CADH;AAEHC,6CAAK,CAFF;AAGHC,+CAAO,IAHJ;AAIHC,gDAAQ,IAJL;AAKHC,oDAAY,EALT;AAMHC,yDAAiB,EANd;AAOHC,+CAAO,EAPJ;AAQHC,mDAAW,QARR;AASHC,kDAAU,EATP;AAUHC,sDAAc;AAVX;AAH0B,iCAAxB,CAAb;;AAiBAZ,uCAAOa,KAAP,CAAa,YAAY;AACrBnB,uCAAGoB,WAAH,CAAe;AACXlB,iDAAS,iBAAUC,GAAV,EAAe;AACpBG,mDAAOe,IAAP;AACAhE,mDAAOiE,QAAP,GAAkBnB,IAAIoB,QAAJ,CAAaD,QAA/B;AACAjE,mDAAOmE,SAAP,GAAmBrB,IAAIoB,QAAJ,CAAaC,SAAhC;AACA/D,+CAAGmB,IAAH,CAAQ6C,IAAR,CAAa,SAAb,EAAwB,IAAxB;AACA3B;AACH,yCAPU;AAQX4B,8CAAM,cAAUvB,GAAV,EAAe;AACjBpB,oDAAQC,GAAR,CAAYmB,GAAZ;AACA1C,+CAAGmB,IAAH,CAAQ6C,IAAR,CAAa,SAAb,EAAwB,KAAxB;AACA1B;AACH;AAZU,qCAAf;AAcH,iCAfD;AAgBH,6BAlCD,MAkCO;AACHC,mCAAG2B,SAAH,CAAa;AACTC,2CAAO,gBADE;AAET1B,2CAFS,qBAEC;AACNF,2CAAGoB,WAAH,CAAe;AACXlB,qDAAS,iBAAUC,GAAV,EAAe;AACpB9C,uDAAOiE,QAAP,GAAkBnB,IAAIoB,QAAJ,CAAaD,QAA/B;AACAjE,uDAAOmE,SAAP,GAAmBrB,IAAIoB,QAAJ,CAAaC,SAAhC;AACA1B;AACH,6CALU;AAMX4B,kDAAM,cAAUvB,GAAV,EAAe;AACjBJ;AACH;AARU,yCAAf;AAUH;AAbQ,iCAAb;AAeH;AAEJ,yBArDD,MAqDO;AACHC,+BAAGoB,WAAH,CAAe;AACXlB,yCAAS,iBAAUC,GAAV,EAAe;AACpBpB,4CAAQC,GAAR,CAAY,KAAZ,EAAmBmB,GAAnB;AACA9C,2CAAOiE,QAAP,GAAkBnB,IAAIoB,QAAJ,CAAaD,QAA/B;AACAjE,2CAAOmE,SAAP,GAAmBrB,IAAIoB,QAAJ,CAAaC,SAAhC;AACA/D,uCAAGmB,IAAH,CAAQ6C,IAAR,CAAa,SAAb,EAAwB,IAAxB;AACA3B;AACH,iCAPU;AAQX4B,sCAAM,cAAUvB,GAAV,EAAe;AACjBJ;AACH;AAVU,6BAAf;AAYH;AACJ;AArES,iBAAd;AAuEH,aAxED,MAwEO;AACHD;AACH;AACJ,SA5EM,CAAP;AA6EH,KApJI;AAqJL+B,SArJK,mBAqJG;AACJpE,WAAGqE,QAAH,CAAYC,YAAZ,CAAyB,MAAzB,EAAiCtE,GAAGuB,GAAH,CAAO,SAAP,CAAjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEH,KAlKI;AAmKLgD,UAnKK,kBAmKEC,EAnKF,EAmKM;AACP,aAAKC,UAAL,CAAgBD,EAAhB;AACH,KArKI;AAsKLC,cAtKK,sBAsKMD,EAtKN,EAsKS;AACV,YAAGzE,eAAH,EAAmB;AACnB,gBAAI,KAAKQ,UAAL,CAAgByB,QAAhB,IAA4B,CAA5B,IAAiClC,aAAa,KAAlD,EAAyD;AACrDA,4BAAY,IAAZ;AACA,qBAAK4E,cAAL;AACH;AACD7E,qBAAS2E,EAAT;AACA,iBAAKjE,UAAL,CAAgByB,QAAhB,GAA6BnC,QAAQ,CAAT,GAAc,CAAd,GAAkB,CAAlB,GAAsBA,QAAQ,CAA1D;AACA,iBAAKgB,cAAL,CAAoB8D,MAApB,GAA6BC,KAAKC,KAAL,CAAW,KAAKtE,UAAL,CAAgByB,QAAhB,GAA2B,GAAtC,IAA6C,GAA1E;AACJ;AACH,KAhLQ;AAiLL0C,kBAjLK,4BAiLY;AACb1E,WAAGqE,QAAH,CAAYS,SAAZ,CAAsB,MAAtB;AACH;AAnLI,CAAT","file":"LoadingSceneJS.js","sourceRoot":"../../../../assets/Scripts","sourcesContent":["var GameDataManager = require(\"GameDataManagerJS\");\nvar define = require(\"define\");\nlet point = 0;\nlet isLoading = false;\nlet isAuthorization = false;\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        wxlog_btn: cc.Node,\n        loadingBar: {\n            type: cc.ProgressBar,\n            default: null\n        },\n        loadinglab: cc.Sprite,\n        loadingpercent: cc.Label,\n        titlebg: cc.Sprite,\n        audioControl:\n        {\n            default: null,\n        },\n    },\n    onLoad() {\n       \n        if (CC_WECHATGAME) {\n            cc.game.on(\"impower\", (sure) => {\n                if (sure) {\n                    console.log(\"授权成功！\")\n                    isAuthorization = true;\n                    this.wxlog_btn.active = false;\n                    this.loadingBar.node.active = true;\n                    this.loadinglab.node.active = true;\n                    this.loadingpercent.node.active = true;\n\n                    GameDataManager.getInstance().preLoadingdata();\n                    if (!define.getgold()) {\n                        GameDataManager.getInstance().savegold(define.money);\n                        cc.log(\"首次加载游戏获取到当前金币(应为100)\", GameDataManager.getInstance().getgold())\n                    }\n                }\n                else { }\n            })\n            this.getInfo();\n            this.loadingBar.progress = 0;\n            this.loadingBar.node.active = false;\n            this.loadinglab.node.active = false;\n            this.loadingpercent.node.active = false;\n        }\n        else {\n            console.log(\"授权成功！\");\n            cc.sys.localStorage.clear();\n            isAuthorization = true;\n            this.wxlog_btn.active = false;\n            this.loadingBar.node.active = true;\n            this.loadinglab.node.active = true;\n            this.loadingpercent.node.active = true;\n\n            GameDataManager.getInstance().preLoadingdata();\n            if (!define.getgold()) {\n                GameDataManager.getInstance().savegold(define.money);\n                cc.log(\"首次加载游戏获取到当前金币(应为100)\", GameDataManager.getInstance().getgold())\n            }\n        }\n\n        // if (!CC_WECHATGAME) {\n        //     this.wxlog_btn.active = false;\n        //     this.loadingBar.node.active = true;\n        //     this.loadinglab.node.active = true;\n        //     this.loadingpercent.node.active = true;\n        //     GameDataManager.getInstance().preLoadingdata();\n        //     if (!define.getgold()) {\n        //         GameDataManager.getInstance().savegold(define.money);\n        //     }\n        // }\n    },\n    getInfo() {\n        return new Promise(function (resolve, reject) {\n            if (CC_WECHATGAME) {\n                wx.getSetting({\n                    success(res) {\n                        if (!res.authSetting['scope.userInfo']) {\n                            if (wx.createUserInfoButton) {\n                                let button = wx.createUserInfoButton({\n                                    type: 'text',\n                                    text: '',\n                                    style: {\n                                        left: 0,\n                                        top: 0,\n                                        width: 5000,\n                                        height: 5000,\n                                        lineHeight: 40,\n                                        backgroundColor: '',\n                                        color: '',\n                                        textAlign: 'center',\n                                        fontSize: 40,\n                                        borderRadius: 10\n                                    }\n                                });\n\n                                button.onTap(function () {\n                                    wx.getUserInfo({\n                                        success: function (res) {\n                                            button.hide();\n                                            define.nickName = res.userInfo.nickName;\n                                            define.avatarUrl = res.userInfo.avatarUrl;\n                                            cc.game.emit(\"impower\", true);\n                                            resolve();\n                                        },\n                                        fail: function (res) {\n                                            console.log(res);\n                                            cc.game.emit(\"impower\", false);\n                                            reject();\n                                        }\n                                    });\n                                });\n                            } else {\n                                wx.authorize({\n                                    scope: 'scope.userInfo',\n                                    success() {\n                                        wx.getUserInfo({\n                                            success: function (res) {\n                                                define.nickName = res.userInfo.nickName;\n                                                define.avatarUrl = res.userInfo.avatarUrl;\n                                                resolve();\n                                            },\n                                            fail: function (res) {\n                                                reject();\n                                            }\n                                        })\n                                    }\n                                })\n                            }\n\n                        } else {\n                            wx.getUserInfo({\n                                success: function (res) {\n                                    console.log('res', res);\n                                    define.nickName = res.userInfo.nickName;\n                                    define.avatarUrl = res.userInfo.avatarUrl;\n                                    cc.game.emit(\"impower\", true);\n                                    resolve();\n                                },\n                                fail: function (res) {\n                                    reject();\n                                }\n                            })\n                        }\n                    }\n                })\n            } else {\n                resolve();\n            }\n        })\n    },\n    start() {\n        cc.director.preloadScene(\"main\", cc.log('预加载main'));\n        //适配\n        // console.log('    cc.winSize =' + cc.winSize);//以磅为单位返回WebGL视图的大小。它考虑了窗口的任何可能的旋转\n        // console.log('    cc.view.getVisibleSize() =' + cc.view.getVisibleSize());//返回正在运行的场景的可见大小\n        // console.log('    cc.view.getFrameSize() =' + cc.view.getFrameSize());//返回视图的帧大小。在本机平台上，它返回屏幕大小，因为视图是全屏视图。在Web上，它返回画布外部DOM元素的大小\n        // console.log('    cc.view.getDesignResolutionSize() =' + cc.view.getDesignResolutionSize());//返回视图的设计大小。默认分辨率大小与'getFrameSize'相同\n        // var DesignResolutionSize = cc.view.getDesignResolutionSize();\n        // var WinSize = cc.winSize;\n        // var nodeX = WinSize.width / DesignResolutionSize.width;\n        // var nodeY = WinSize.height / DesignResolutionSize.height;\n        // console.log('    nodeX=   ' + nodeX + '  nodeY=' + nodeY);\n\n    },\n    update(dt) {\n        this.updateload(dt);\n    },\n    updateload(dt){\n        if(isAuthorization){\n        if (this.loadingBar.progress >= 1 && isLoading == false) {\n            isLoading = true;\n            this.onLoadComplete();\n        }\n        point += dt;\n        this.loadingBar.progress = ((point / 3) > 1 ? 1 : point / 3);\n        this.loadingpercent.string = Math.floor(this.loadingBar.progress * 100) + \"%\";\n   } \n},\n    onLoadComplete() {\n        cc.director.loadScene(\"main\");\n    },\n});"]}